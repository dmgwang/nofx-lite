#!/bin/bash
set -e

echo "ğŸš€ Quick deploy (macOS) starting..."

# Copy .env file from example if it doesn't exist
if [ ! -f .env ] && [ -f .env.example ]; then
  cp .env.example .env
  echo "ğŸ“„ Created .env from .env.example"
fi

echo "âš ï¸  WARNING: Using default configuration from .env.example!"
echo "ğŸ”’ For production deployment, please manually update the following values in .env:"
echo "   - DATA_ENCRYPTION_KEY"
echo "   - JWT_SECRET"
echo "   - Any other secrets or API keys"
echo ""

# Copy config.json if it doesn't exist
[ ! -f config.json ] && [ -f config.json.example ] && cp config.json.example config.json && echo "ğŸ“„ Created config.json from config.json.example"

# Generate key material (RSA + AES master key) if Go is available; otherwise backend will generate on first run
if command -v go >/dev/null 2>&1; then
  echo "ğŸ”‘ Generating keys via go run ./cmd/genkeys"
  go run ./cmd/genkeys
else
  echo "âš ï¸  Go not found; keys will be auto-generated by backend on first start"
fi

# Build and start services
echo "ğŸ—ï¸  Building containers..."
docker compose build
echo "â–¶ï¸  Starting containers..."
docker compose up -d

echo "âœ… Deployment complete! Web interface should be available at http://localhost:3000"
echo "ğŸ’¡ Use 'docker compose logs -f' to view logs"