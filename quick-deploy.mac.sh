#!/bin/bash
set -e

echo "üöÄ Quick deploy (macOS) starting..."

# Copy .env file from example if it doesn't exist
if [ ! -f .env ] && [ -f .env.example ]; then
  cp .env.example .env
  echo "üìÑ Created .env from .env.example"
fi

echo "‚ö†Ô∏è  WARNING: Using default configuration from .env.example!"
echo "üîí For production deployment, please manually update the following values in .env:"
echo "   - DATA_ENCRYPTION_KEY"
echo "   - JWT_SECRET"
echo "   - Any other secrets or API keys"
echo ""

# Copy config.json if it doesn't exist
[ ! -f config.json ] && [ -f config.json.example ] && cp config.json.example config.json && echo "üìÑ Created config.json from config.json.example"

# Generate key material (RSA + AES master key) if Go is available; otherwise backend will generate on first run
if command -v go >/dev/null 2>&1; then
  echo "üîë Generating keys via go run ./cmd/genkeys"
  go run ./cmd/genkeys
else
  echo "‚ö†Ô∏è  Go not found; keys will be auto-generated by backend on first start"
fi

# Build and start services
echo "üèóÔ∏è  Building containers (with PostgreSQL)..."
docker compose build
echo "‚ñ∂Ô∏è  Starting containers..."
docker compose up -d

echo "‚úÖ Deployment complete! Web interface should be available at http://localhost:3000"
echo "üí° Use 'docker compose logs -f' to view logs"
if ! grep -q '^DATABASE_URL=' .env 2>/dev/null; then
  echo "‚ÑπÔ∏è  DATABASE_URL not set in .env; backend will use default: postgres://postgres:postgres@postgres:5432/nofx?sslmode=disable"
fi
